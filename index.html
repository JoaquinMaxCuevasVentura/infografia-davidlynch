<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAVID LYNCH | Infografía</title>

    <!-- FUENTES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- ICONOS -->
    <link href="https://cdn.jsdelivr.net/npm/dflip/css/themify-icons.min.css" rel="stylesheet" type="text/css">

    <!-- LIBRERÍA OCR (TESSERACT) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-color: #050505;      
            --accent-color: #dc6b2f;  
            --text-main: #FFFFFF;     
        }

        body, html {
            height: 100%; margin: 0;
            background-color: var(--bg-color);
            font-family: 'Archivo', sans-serif !important;
            overflow: hidden;
        }

        /* FONDO */
        #grained-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        /* VISOR */
        #openseadragon-viewer {
            width: 100%; height: 100%;
            background: transparent;
            position: absolute; top: 0; left: 0;
            z-index: 10;
        }

        /* --- BARRA DE HERRAMIENTAS --- */
        #custom-toolbar {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            background: transparent; padding: 0;
            gap: 25px; 
        }

        .custom-btn {
            background: transparent; border: none;
            color: #AAAAAA; cursor: pointer;
            width: auto; height: 30px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease; padding: 0; outline: none;
            position: relative; pointer-events: auto;
        }

        .custom-btn i {
            font-size: 20px; line-height: 1;
            display: block; font-weight: normal;
        }

        /* Ajustes ópticos de iconos */
        #btn-info i { font-size: 17px; position: relative; top: -1px; }
        #btn-ocr i { font-size: 18px; position: relative; top: 0px; }

        .custom-btn:hover, .custom-btn.active {
            color: var(--accent-color);
            transform: scale(1.2);
            text-shadow: 0 0 15px rgba(220, 107, 47, 0.6);
        }

        /* --- LOADING OCR (NUEVO) --- */
        #ocr-loading {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(5, 5, 5, 0.95);
            color: var(--accent-color);
            padding: 30px 50px;
            border: 1px solid #333;
            z-index: 10001;
            display: none; /* Oculto por defecto */
            flex-direction: column; align-items: center; gap: 15px;
            font-size: 12px; letter-spacing: 3px; text-transform: uppercase;
            font-weight: 600;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.4; } }

        /* --- MODAL INFO --- */
        .modal-overlay {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98); 
            z-index: 10000; 
            justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { display: flex; opacity: 1; }

        .modal-content {
            color: #fff; max-width: 500px; width: 80%;
            text-align: center; position: relative;
        }
        .modal-line { width: 40px; height: 2px; background-color: var(--accent-color); margin: 20px auto; }
        .modal-title { font-size: 24px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 3px; }
        .modal-subtitle { font-size: 11px; color: var(--accent-color); margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }
        .modal-body { font-size: 14px; color: #ccc; line-height: 1.6; font-weight: 300; }
        .modal-note { margin-top: 30px; font-size: 10px; color: #666; border-top: 1px solid #222; padding-top: 15px; }
        
        .close-modal { 
            position: absolute; top: -50px; right: 0; 
            color: #666; font-size: 30px; cursor: pointer; 
            transition: 0.2s; font-weight: 100; font-family: sans-serif;
        }
        .close-modal:hover { color: var(--accent-color); }

    </style>
</head>
<body>

    <!-- FONDO -->
    <div id="grained-container"></div>

    <!-- INDICADOR DE CARGA (OCR) -->
    <div id="ocr-loading">
        <i class="ti-eye blink" style="font-size: 24px;"></i>
        <span>Procesando...</span>
    </div>

    <!-- MODAL (INFO + RESULTADOS) -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" id="btn-close-modal">✕</span>
            <div class="modal-title" id="modal-title">DAVID LYNCH</div>
            <div class="modal-subtitle" id="modal-subtitle">DECODIFICACIÓN FÍLMICA [INFOGRAFÍA]</div>
            <div class="modal-line"></div>
            <div class="modal-body" id="modal-body">
                <!-- El contenido se llena dinámicamente con JS -->
            </div>
        </div>
    </div>

    <!-- BARRA DE HERRAMIENTAS -->
    <div id="custom-toolbar">
        <button class="custom-btn" id="btn-zoom-in" title="Acercar"><i class="ti-zoom-in"></i></button>
        <button class="custom-btn" id="btn-zoom-out" title="Alejar"><i class="ti-zoom-out"></i></button>
        <button class="custom-btn" id="btn-full" title="Pantalla Completa"><i class="ti-fullscreen"></i></button>
        
        <!-- BOTÓN DE OCR/TRADUCCIÓN -->
        <button class="custom-btn" id="btn-ocr" title="Escanear y Traducir Vista Actual"><i class="ti-text"></i></button>
        
        <button class="custom-btn" id="btn-info" title="Información"><i class="ti-info-alt"></i></button>
    </div>

    <!-- VISOR -->
    <div id="openseadragon-viewer"></div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/grained/0.0.2/grained.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

    <script>
        // --- 1. CONFIGURACIÓN VISUAL ---
        try {
            grained('#grained-container', {
                "animate": true, "patternWidth": 100, "patternHeight": 100,
                "grainOpacity": 0.05, "grainDensity": 1, "grainWidth": 1, "grainHeight": 1
            });
        } catch(e) { console.log("Error cargando grano"); }

        // --- 2. GESTIÓN DEL MODAL ---
        const modal = document.getElementById('infoModal');
        const modalTitle = document.getElementById('modal-title');
        const modalSubtitle = document.getElementById('modal-subtitle');
        const modalBody = document.getElementById('modal-body');
        const btnInfo = document.getElementById('btn-info');
        const btnClose = document.getElementById('btn-close-modal');

        // Contenido por defecto (Información del Proyecto)
        const defaultInfoHTML = `
            <p>INVESTIGACIÓN, REDACCIÓN E ILUSTRACIÓN<br>
            <strong style="color:white; font-size:15px; letter-spacing:1px;">Joaquin Max Cuevas Ventura</strong><br>
            2021</p>
            <div class="modal-note">
                Nota: Este fue un ejercicio de diseño de información, por lo que esta publicación constituye un proyecto académico exento de cualquier propósito comercial o de lucro.
            </div>
        `;

        function openModal(mode, textData = {}) {
            // Configurar contenido según modo
            if (mode === 'info') {
                modalTitle.innerText = "DAVID LYNCH";
                modalSubtitle.innerText = "DECODIFICACIÓN FÍLMICA [INFOGRAFÍA]";
                modalBody.innerHTML = defaultInfoHTML;
            } else if (mode === 'ocr') {
                modalTitle.innerText = "ANÁLISIS DE TEXTO";
                modalSubtitle.innerText = "OCR & LIBRETRANSLATE";
                
                const colorTrans = textData.isError ? '#ff5555' : '#aaaaaa';
                
                modalBody.innerHTML = `
                    <div style="text-align: left; margin-bottom: 25px;">
                        <strong style="color:var(--accent-color); font-size:11px; letter-spacing:1px;">ORIGINAL (ES):</strong><br>
                        <p style="font-size: 13px; color: #fff; margin-top:5px; white-space: pre-wrap;">${textData.original}</p>
                    </div>
                    <div style="border-top: 1px solid #333; padding-top: 20px; text-align: left;">
                        <strong style="color:var(--accent-color); font-size:11px; letter-spacing:1px;">TRADUCCIÓN (EN):</strong><br>
                        <p style="font-size: 13px; color: ${colorTrans}; margin-top:5px; white-space: pre-wrap;">${textData.translated}</p>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            if(mode === 'info') btnInfo.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
            btnInfo.classList.remove('active');
        }

        // Eventos Modal
        btnInfo.onclick = () => {
            if (modal.classList.contains('show') && btnInfo.classList.contains('active')) {
                closeModal();
            } else {
                openModal('info');
            }
        };
        btnClose.onclick = closeModal;
        window.onclick = (e) => { if (e.target == modal) closeModal(); }


        // --- 3. OPENSEADRAGON ---
        var imageName = "FILMOGRAFIADAVIDLYNCH_InfografiaCompleta_WEB-FINAL_v01_18122025.png";

        var viewer = OpenSeadragon({
            id: "openseadragon-viewer",
            prefixUrl: "", 
            tileSources: {
                type: 'image', url: imageName, buildPyramid: false
            },
            showNavigationControl: false,
            wrapHorizontal: false, wrapVertical: false,
            visibilityRatio: 0.5, minZoomImageRatio: 0.5, maxZoomPixelRatio: 5,        
            defaultZoomLevel: 0,         
            gestureSettingsMouse: { clickToZoom: false, scrollToZoom: true },
            animationTime: 0.4
        });

        // Botones de Navegación
        document.getElementById('btn-zoom-in').addEventListener('click', () => {
            viewer.viewport.zoomTo(viewer.viewport.getZoom() * 1.5);
        });
        document.getElementById('btn-zoom-out').addEventListener('click', () => {
            viewer.viewport.zoomTo(viewer.viewport.getZoom() / 1.5);
        });
        document.getElementById('btn-full').addEventListener('click', () => {
            viewer.setFullScreen(!viewer.isFullScreen());
        });


        // --- 4. LÓGICA OCR Y TRADUCCIÓN (LibreTranslate) ---
        const btnOcr = document.getElementById('btn-ocr');
        const loadingEl = document.getElementById('ocr-loading');

        // Función Auxiliar: Traducir
        async function translateText(text) {
            // URL de instancia pública (Puede cambiar o saturarse)
            // Alternativas: https://libretranslate.de/translate , https://translate.argosopentech.com/translate
            const API_URL = "https://libretranslate.de/translate"; 
            
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        q: text,
                        source: "es",
                        target: "en",
                        format: "text"
                    }),
                    headers: { "Content-Type": "application/json" }
                });

                if(!res.ok) throw new Error("Error HTTP " + res.status);
                
                const data = await res.json();
                return data.translatedText;
            } catch (err) {
                console.warn("Fallo en traducción:", err);
                return "[ERROR DE CONEXIÓN] El servidor de traducción gratuito no responde o bloqueó la solicitud (CORS). Intenta de nuevo más tarde o revisa la consola.";
            }
        }

        btnOcr.addEventListener('click', async function() {
            // UI: Mostrar carga
            loadingEl.style.display = 'flex';
            
            try {
                // 1. Obtener imagen del Canvas actual
                var canvas = viewer.drawer.canvas;
                var dataUrl = canvas.toDataURL("image/png");

                // 2. Ejecutar Tesseract (OCR)
                // Descargará el módulo la primera vez
                const result = await Tesseract.recognize(dataUrl, 'spa');
                const textDetectado = result.data.text;

                // Validación simple
                if (!textDetectado || textDetectado.trim().length < 2) {
                    alert("No se detectó texto legible. Haz zoom sobre un párrafo e intenta de nuevo.");
                    loadingEl.style.display = 'none';
                    return;
                }

                // 3. Traducir
                const textTraducido = await translateText(textDetectado);
                const isError = textTraducido.includes("[ERROR");

                // 4. Mostrar Resultados
                loadingEl.style.display = 'none';
                openModal('ocr', { 
                    original: textDetectado, 
                    translated: textTraducido,
                    isError: isError
                });

            } catch (error) {
                console.error(error);
                loadingEl.style.display = 'none';
                alert("Ocurrió un error al procesar la imagen.");
            }
        });

    </script>

</body>
</html>
